<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>登录 - 小松鼠</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: radial-gradient(circle at 50% 20%, rgba(108, 92, 231, 0.25), transparent 45%),
        linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    }

    .login-card {
      width: min(420px, 90vw);
      padding: 2rem;
      border-radius: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: #fff;
      text-align: center;
    }

    .login-card h1 { margin-bottom: 0.5rem; font-size: 1.6rem; }
    .login-card .subtitle { margin-bottom: 1.5rem; color: rgba(255, 255, 255, 0.7); }
    .login-card .hint { font-size: 0.8rem; color: rgba(255, 255, 255, 0.5); margin-bottom: 1rem; display: none; }
    .login-card.register-mode .hint { display: block; }
    .login-card form { display: flex; flex-direction: column; gap: 1rem; }
    .login-card input[type="password"] {
      width: 100%; padding: 0.85rem 1rem; border-radius: 0.7rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.08); color: #fff; outline: none;
    }
    .login-card .btn {
      padding: 0.9rem; border: none; border-radius: 0.8rem;
      background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
      color: #fff; font-weight: 700; cursor: pointer;
    }
    .login-card .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.35); }
    .login-card .error { color: #ffb4b4; font-size: 0.95rem; margin-bottom: 0.5rem; }
    .login-card .success { color: #b4ffb4; font-size: 0.95rem; margin-bottom: 0.5rem; }
    .remember-me { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); cursor: pointer; width: fit-content; }
    .remember-me input { width: 1.1em; height: 1.1em; accent-color: #6c5ce7; cursor: pointer; }
    .confirm-field { display: none; }
    .login-card.register-mode .confirm-field { display: block; }
    .login-card.register-mode .remember-me { display: none; }
    .toggle-mode { margin-top: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); }
    .toggle-mode a { color: #a29bfe; text-decoration: none; cursor: pointer; }
    .toggle-mode a:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <div class="login-card" id="loginCard">
    <h1>小松鼠</h1>
    <p class="subtitle" id="subtitle">请输入密码登录</p>
    <div class="hint">密码要求：至少6位，必须包含数字和字母</div>
    {% if error %}<div class="error">{{ error }}</div>{% endif %}
    <div class="error" id="clientError" style="display:none;"></div>
    <div class="success" id="clientSuccess" style="display:none;"></div>
    <form method="POST" id="authForm" action="/login">
      <input type="password" name="password" id="password" placeholder="密码" required>
      <input type="password" name="confirm" id="confirm" class="confirm-field" placeholder="确认密码">
      <input type="hidden" name="raw_password" id="raw_password">
      <input type="hidden" name="mode" id="mode" value="login">
      <label class="remember-me"><input type="checkbox" name="remember"><span>保持登录</span></label>
      <button type="submit" class="btn" id="submitBtn">登录</button>
    </form>
    <div class="toggle-mode">
      <span id="toggleText">没有账户？</span>
      <a id="toggleLink" onclick="toggleMode()">立即注册</a>
    </div>
  </div>
  <script>
    let isRegisterMode = false;
    function toggleMode() {
      isRegisterMode = !isRegisterMode;
      const card = document.getElementById('loginCard');
      const subtitle = document.getElementById('subtitle');
      const submitBtn = document.getElementById('submitBtn');
      const toggleText = document.getElementById('toggleText');
      const toggleLink = document.getElementById('toggleLink');
      const modeInput = document.getElementById('mode');
      const confirmInput = document.getElementById('confirm');
      document.getElementById('clientError').style.display = 'none';
      document.getElementById('clientSuccess').style.display = 'none';
      if (isRegisterMode) {
        card.classList.add('register-mode');
        subtitle.textContent = '创建新账户';
        submitBtn.textContent = '注册';
        toggleText.textContent = '已有账户？';
        toggleLink.textContent = '立即登录';
        modeInput.value = 'register';
        confirmInput.required = true;
      } else {
        card.classList.remove('register-mode');
        subtitle.textContent = '请输入密码登录';
        submitBtn.textContent = '登录';
        toggleText.textContent = '没有账户？';
        toggleLink.textContent = '立即注册';
        modeInput.value = 'login';
        confirmInput.required = false;
      }
    }
    function validatePassword(pwd) {
      if (pwd.length < 6) return { valid: false, msg: '密码必须至少6位' };
      if (!/[a-zA-Z]/.test(pwd) || !/[0-9]/.test(pwd)) return { valid: false, msg: '密码必须包含数字和字母' };
      return { valid: true, msg: '' };
    }
    function showError(msg) {
      document.getElementById('clientError').textContent = msg;
      document.getElementById('clientError').style.display = 'block';
      document.getElementById('clientSuccess').style.display = 'none';
    }
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    document.getElementById('authForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const pwd = document.getElementById('password').value;
      const confirm = document.getElementById('confirm').value;
      const mode = document.getElementById('mode').value;
      if (mode === 'register') {
        const result = validatePassword(pwd);
        if (!result.valid) { showError(result.msg); return; }
        if (pwd !== confirm) { showError('两次输入的密码不一致'); return; }
        document.getElementById('raw_password').value = pwd;
      }
      try {
        const hashed = await sha256(pwd);
        document.getElementById('password').value = hashed;
        if (mode === 'register') document.getElementById('confirm').value = hashed;
        this.submit();
      } catch (err) { this.submit(); }
    });
  </script>
</body>
</html>
